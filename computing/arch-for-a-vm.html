<!DOCTYPE html>
<html lang="en-GB"><meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" /><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Arch for a VM" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Sometimes you can’t escape Windows" />
<meta property="og:description" content="Sometimes you can’t escape Windows" />
<link rel="canonical" href="https://willpower232.github.io/computing/arch-for-a-vm.html" />
<meta property="og:url" content="https://willpower232.github.io/computing/arch-for-a-vm.html" />
<meta property="og:site_name" content="Blogumentation willpower232" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-09-23T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Arch for a VM" />
<script type="application/ld+json">
{"description":"Sometimes you can’t escape Windows","url":"https://willpower232.github.io/computing/arch-for-a-vm.html","@type":"BlogPosting","headline":"Arch for a VM","dateModified":"2021-09-23T00:00:00+00:00","datePublished":"2021-09-23T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://willpower232.github.io/computing/arch-for-a-vm.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<title>
	
		Arch for a VM
	
</title>


	<meta itemprop="description" name="description" content="Sometimes you can't escape Windows" />


<meta property="og:locale" content="en_GB" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Arch for a VM" />
<meta property="og:site_name" content="Blogumentation | willpower232" />

	<meta property="og:description" content="Sometimes you can't escape Windows" />


<meta name="twitter:title" content="Arch for a VM" />

	<meta name="twitter:description" content="Sometimes you can't escape Windows" />

<meta name="twitter:site" content="@willpower232" />
<meta name="twitter:card" content="summary" />

<meta name="fediverse:creator" content="@willpower232@php.social" />

<link rel="stylesheet" href="/assets/main.css" />

<link rel="icon" href="/favicon.png" />

<meta name="pinterest" content="nopin" />
<body><header>
	<hgroup>
		<h2>Blogumentation</h2>
		<p>helping future me remember cool things</p>
	</hgroup>
	<nav>
		<menu>
			<li><a href="/">Home</a></li>
			<!-- <li><a href="#">Projects</a></li> -->
		</menu>
	</nav>
</header>

    

    

    
        <nav>
            <h3>Tags in computing</h3>
            <menu>
                
                    <li><a href="/aws/">aws</a></li>
                
                    <li><a href="/gaming/">gaming</a></li>
                
                    <li><a href="/linux/">linux</a></li>
                
                    <li><a href="/server-config/">server-config</a></li>
                
                    <li><a href="/software-choices/">software-choices</a></li>
                
            </menu>
        </nav>
    

    <main>
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 itemprop="name headline">Arch for a VM</h1>
	<p class="post-meta">First written<time datetime="2021-09-23T00:00:00+00:00" itemprop="datePublished">
			2021-09-23
		</time>~ last updated<time datetime="2021-11-18T00:00:00+00:00" itemprop="dateModified">
				2021-11-18
			</time></p>

	<div class="post-content" itemprop="articleBody">
		<p>I want a lightweight VM so that my laptop can stay Windows and I can still develop as I am used to.</p>

<h2 id="manual-installation">Manual Installation</h2>

<p>Start by making the VM in Virtualbox and boot an arch iso.</p>

<p>Open <code class="language-plaintext highlighter-rouge">cfdisk</code> to format the disk, select dos type when it asks otherwise none of this will work.</p>

<p>Make two partitions 1g or so for boot, rest for normal but mark it as bootable.</p>

<p>Now we can encrypt the main partition for extra security with the following commands.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cryptsetup -y -v luksFormat /dev/sda2
# cryptsetup open /dev/sda2 cryptroot
# mkfs.ext4 /dev/mapper/cryptroot
# mount /dev/mapper/cryptroot /mnt
</code></pre></div></div>

<p>Finally, we need to prepare the boot partition.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># mkfs.ext4 /dev/sda1
# mkdir /mnt/boot
# mount /dev/sda1 /mnt/boot
</code></pre></div></div>

<p>Now we can continue with the installation, I’ve added a few packages to save some time, at minimum you need linux, linux-firmware if not on a VM, a text editor like vim, a boot manager like grub, and some way of networking.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacstrap /mnt base linux vim grub networkmanager doas which net-tools xclip
# genfstab -U /mnt &gt;&gt; /mnt/etc/fstab
# arch-chroot /mnt
</code></pre></div></div>

<h3 id="initial-configuration">Initial configuration</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ln -sf /usr/share/zoneinfo/Europe/London /etc/localtime
# hwclock --systohc
</code></pre></div></div>

<p>Uncomment your locale from locale.gen and maybe give yourself US as well just in case (e.g. en_US.UTF-8 UTF-8)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># vim /etc/locale.gen
# locale-gen to generate the locales
# echo 'LANG=en-US.UTF-8' &gt; /etc/locale.conf
</code></pre></div></div>

<p>see also localectl status and localectl list-keymaps
https://wiki.archlinux.org/title/Linux_console/Keyboard_configuration</p>

<p>if you need to type a fancy character like #~@” in the imminent future then you probably want the short lived version which is just <code class="language-plaintext highlighter-rouge">loadkeys uk</code></p>

<p>for the future, you can set console keyboard layout in /etc/vconsole.conf with <code class="language-plaintext highlighter-rouge">KEYMAP=uk</code></p>

<p>set hostname (e.g. arch) and /etc/hosts file with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1 localhost
::1 localhost
127.0.1.1 arch.localdomain arch
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">passwd</code> to set root password then you can make your own account</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /home/wp &amp;&amp; useradd wp --shell /bin/bash &amp;&amp; passwd wp &amp;&amp; chown -R wp:wp /home/wp &amp;&amp; usermod -aG wheel wp
</code></pre></div></div>

<h3 id="prepare-boot-manager">Prepare boot manager</h3>

<p>Edit <code class="language-plaintext highlighter-rouge">/etc/mkinitcpio.conf</code> and to the <code class="language-plaintext highlighter-rouge">HOOKS</code> array, add <code class="language-plaintext highlighter-rouge">keyboard</code> between <code class="language-plaintext highlighter-rouge">autodetect</code> and <code class="language-plaintext highlighter-rouge">modconf</code> and add <code class="language-plaintext highlighter-rouge">encrypt</code> between <code class="language-plaintext highlighter-rouge">block</code> and <code class="language-plaintext highlighter-rouge">filesystems</code>. Apply with <code class="language-plaintext highlighter-rouge">mkinitcpio -P</code>.</p>

<p>Now we need the uuid of the partition we installed to <code class="language-plaintext highlighter-rouge">blkid -s UUID -o value /dev/sda2</code>. Take a photo or write it down.</p>

<p>Now edit <code class="language-plaintext highlighter-rouge">/etc/default/grub</code> and update <code class="language-plaintext highlighter-rouge">GRUB_CMDLINE_LINUX</code> with your uuid instead of <code class="language-plaintext highlighter-rouge">xxxx</code> as follows. Also set timeout to zero to save some time.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GRUB_CMDLINE_LINUX="cryptdevice=UUID=xxxx:cryptroot"
</code></pre></div></div>

<p>Now we can install grub (its the disk not partition!)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grub-install --target=i386-pc /dev/sda
# grub-mkconfig -o /boot/grub/grub.cfg
</code></pre></div></div>

<h3 id="final-configuration">Final configuration</h3>

<p>Allow networking to happen</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># systemctl enable NetworkManager
</code></pre></div></div>

<p>I’m trying out <code class="language-plaintext highlighter-rouge">doas</code> instead of <code class="language-plaintext highlighter-rouge">sudo</code> but I can’t just remember so <code class="language-plaintext highlighter-rouge">ln -s $(which doas) /usr/bin/sudo</code></p>

<p>You need to add a group to <code class="language-plaintext highlighter-rouge">/etc/doas.conf</code>. They don’t want you to use <code class="language-plaintext highlighter-rouge">persist</code> because the timeout for it is weird so <code class="language-plaintext highlighter-rouge">nopass</code> is probably preferred in this environment.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>permit nopass :wheel
</code></pre></div></div>

<p>You can verify the config file</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># doas -C /etc/doas.conf &amp;&amp; echo "config ok" || echo "config error"
</code></pre></div></div>

<p>reboot to win</p>

<p>references:</p>
<ul>
  <li>https://blog.bespinian.io/posts/installing-arch-linux-on-uefi-with-full-disk-encryption/</li>
  <li>https://wiki.archlinux.org/title/installation_guide</li>
</ul>

<h2 id="desktop-environment">Desktop Environment</h2>

<p>full update (also if you’re getting 404’s then just <code class="language-plaintext highlighter-rouge">-Sy</code>)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sudo pacman -Syu
</code></pre></div></div>

<p>no escape from xorg</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S xorg-server xorg-xinit xorg-twm xorg-xclock xterm xorg-apps
</code></pre></div></div>

<p>xfce4</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S xfce4 xfce4-goodies
</code></pre></div></div>

<p>need graphics</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S xf86-video-vesa
</code></pre></div></div>

<p>need display manager</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S lightdm lightdm-gtk-greeter
# systemctl enable lightdm
</code></pre></div></div>

<p>reboot to graphics and then
also now you likely have <code class="language-plaintext highlighter-rouge">libxkbcommon</code> and <code class="language-plaintext highlighter-rouge">libxkbcommon-x11</code> which means you can do</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>localectl set-x11-keymap gb
</code></pre></div></div>

<p>reference:</p>
<ul>
  <li>https://nullcodelinux.wordpress.com/2018/01/21/installing-a-desktop-environment-on-arch-linux/</li>
</ul>

<h3 id="final-setup">Final Setup</h3>

<p>In terminal Go to Edit &gt; Preferences &gt; General tab and uncheck “Show unsafe paste dialog”.</p>

<p>add bashrc’s and then
<code class="language-plaintext highlighter-rouge">pacman -S bash-completion</code>
probably need to add this to .bashrc
<code class="language-plaintext highlighter-rouge">. /usr/share/bash-completion/bash_completion</code></p>

<h3 id="virtualbox-guest-additions">virtualbox guest additions</h3>

<p><code class="language-plaintext highlighter-rouge">pacman -S linux-headers gcc make perl</code></p>

<p>mount the cdrom (sr0?) and then do the do</p>

<p>although apparently arch provides but its not as good maybe? (also see tips for mounting folders)
https://wiki.archlinux.org/title/VirtualBox/Install_Arch_Linux_as_a_guest</p>

<p>Random things which may help</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo lsmod | grep vbox
sudo modprobe vboxsf
sudo pacman -S virtualbox-guest-iso
sudo rcvboxadd setup
</code></pre></div></div>

<p>for ssh client and server but you don’t need to enable server
pacman -S openssh</p>

<p>I wanted to use podman but I just couldn’t figure out how to make it work so I’m giving up on it for now.</p>

<p>vscode full version from yay, can’t install base-devel without overwriting doas pretending to be sudo</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cd /opt/
# pacman -S git fakeroot
# git clone https://aur.archlinux.org/yay.git
# su wp
$ cd yay
$ makepkg -si
$ yay -S visual-studio-code-bin
</code></pre></div></div>

<p>you also need gnome-keyring or keepassxc
https://www.cogitri.dev/posts/03-keepassxc-freedesktop-secret/</p>

<p><code class="language-plaintext highlighter-rouge">pacman -S ttf-fira-code</code></p>

<p>also need to have <code class="language-plaintext highlighter-rouge">~/.gnupg/gpg-agent.conf</code> with <code class="language-plaintext highlighter-rouge">pinentry-program /usr/bin/pinentry-qt</code> and then <code class="language-plaintext highlighter-rouge">gpg-connect-agent reloadagent /bye</code> to reload agent</p>

<p>get epiphany for gnome web</p>

<h3 id="mounting-lvm">Mounting LVM</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cryptsetup open /dev/sdb5 whatever
# mkdir /mnt/whatever
</code></pre></div></div>

<p>if <code class="language-plaintext highlighter-rouge">blkid</code> shows you have ext4 then you can just mount it</p>

<p>if <code class="language-plaintext highlighter-rouge">blkid</code> shows you have LVM2_member then</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pacman -S lvm2
# lvscan
# vgchange -ay
# lvscan
# mount /dev/oldlvmname/root /mnt/whatever
</code></pre></div></div>

<h3 id="emoji-terminal-support">Emoji terminal support</h3>
<ol>
  <li>install  noto-fonts-emoji package
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code># pacman -S noto-fonts-emoji --needed
</code></pre></div>    </div>
  </li>
  <li>add font config to <code class="language-plaintext highlighter-rouge">/etc/fonts/conf.d/01-notosans.conf</code>
</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE fontconfig SYSTEM "fonts.dtd"&gt;
&lt;fontconfig&gt;
 &lt;alias&gt;
   &lt;family&gt;sans-serif&lt;/family&gt;
   &lt;prefer&gt;
     &lt;family&gt;Noto Sans&lt;/family&gt;
     &lt;family&gt;Noto Color Emoji&lt;/family&gt;
     &lt;family&gt;Noto Emoji&lt;/family&gt;
     &lt;family&gt;DejaVu Sans&lt;/family&gt;
   &lt;/prefer&gt;
 &lt;/alias&gt;

 &lt;alias&gt;
   &lt;family&gt;serif&lt;/family&gt;
   &lt;prefer&gt;
     &lt;family&gt;Noto Serif&lt;/family&gt;
     &lt;family&gt;Noto Color Emoji&lt;/family&gt;
     &lt;family&gt;Noto Emoji&lt;/family&gt;
     &lt;family&gt;DejaVu Serif&lt;/family&gt;
   &lt;/prefer&gt;
 &lt;/alias&gt;

 &lt;alias&gt;
  &lt;family&gt;monospace&lt;/family&gt;
  &lt;prefer&gt;
    &lt;family&gt;Noto Mono&lt;/family&gt;
    &lt;family&gt;Noto Color Emoji&lt;/family&gt;
    &lt;family&gt;Noto Emoji&lt;/family&gt;
    &lt;family&gt;DejaVu Sans Mono&lt;/family&gt;
   &lt;/prefer&gt;
 &lt;/alias&gt;
&lt;/fontconfig&gt;

" &gt; /etc/fonts/local.conf
</code></pre></div></div>

<ol>
  <li>update font cache via fc-cache</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># fc-cache
</code></pre></div></div>

<p>https://dev.to/darksmile92/get-emojis-working-on-arch-linux-with-noto-fonts-emoji-2a9</p>

<h2 id="automatic-installation">Automatic Installation</h2>

<p>The manual installation was okay but the virtualbox integration never fully worked, I was probably missing a implicit dependency somewhere but I don’t know.</p>

<p>I randomly found that there was an effort to create an installer which reduces a lot of the above into some easy choices https://itsfoss.com/install-arch-linux-virtualbox/</p>

<p>It does not currently support disk encryption with grub so you have to enable the EFI setting before starting the VM for the first time.</p>

<p>Boot and enter <code class="language-plaintext highlighter-rouge">archinstall</code>. Answer all the prompts, allow systemd-boot, don’t allow your user to be sudo since we’ll do that differently later. Select “desktop” and your environment of choice (LXQT for lightweightness). Choose virtualbox graphics and probably all the other defaults. additional packages: <code class="language-plaintext highlighter-rouge">vim opendoas which net-tools xclip openssh bash-completion sakura</code>. select the network interface rather than networkmanager to save some time and effort, allow DHCP and enter your timezone.</p>

<p>You don’t need to chroot so exit back to installer and <code class="language-plaintext highlighter-rouge">shutdown now</code> so you can remove the iso.</p>

<p>Install vbox additions from cd, uninstall sudo, configure doas for group named after user you made earlier, also add user you made earlier to group vboxsf.</p>

<p><code class="language-plaintext highlighter-rouge">sudo mount -t vboxsf -o gid=vboxsf shared_folder_name mount_point_on_guest_system</code></p>

<h3 id="lxqt">LXQT</h3>
<ul>
  <li>remove quick launcher and desktop switcher widgets</li>
  <li>lxqt preferences - appearance (icons to adwaita, theme to clearlooks)</li>
  <li>openbox settings (theme to bear2, desktops down to 1)</li>
</ul>

<h3 id="other-des">OTHER DEs</h3>

<p>If you want to use lxde or something not on the list then add it to the packages you install <code class="language-plaintext highlighter-rouge">lightdm lightdm-gtk-greeter lxde</code> and when prompted, you should chroot so that you can <code class="language-plaintext highlighter-rouge">systemctl enable lightdm</code></p>

<h2 id="thrilling-conclusion">Thrilling Conclusion(?)</h2>

<p>The automatic install meant that installing the virtualbox tools from the CD worked perfectly so I was able to get further with docker and vscode as above however I needed to install PHP for validating code as I write it.</p>

<p>I was able to install literally everything else apart from PHP 7.4. That is only available from yay and that means it needs compiling and the VM didn’t quite have enough resources for that so it froze and I had to kill the VM.</p>

<p>At this point, I don’t know if I will persist or give up and install Zorin Lite 16 when that comes out. We’ll see.</p>

	</div>
</article>

    </main><footer>
	© William Hall<br>
	<a href="mailto:will@willpoweredinc.net">will@willpoweredinc.net</a>
</footer>

<aside>
	<div>
		<a href="https://willpower232.com" target="_blank" rel="noopener noreferrer">
			<svg><use xlink:href="/assets/template/footlink.svg#icon-face"></use></svg>
		</a>
	</div>
</aside>
</body>

<script src="/assets/template/fixremotesvgs.js"></script>
<script src="/assets/template/shareorcopy.js"></script>

<!--
needless to say, the reverse dutch classic
overarm was now out of the question
-->
